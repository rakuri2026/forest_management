-- Test azimuth calculation for nearby features
-- This will help us understand why East/South/West are empty

WITH input_geom AS (
    SELECT ST_GeomFromText('POLYGON((85.06166514100008 27.41872503600006,85.06203161900002 27.418646880000075,85.06232481400012 27.41863380400006,85.062764611 27.41862069600004,85.06308713600005 27.418633638000045,85.0633639512823 27.41868062614693,85.06409379800003 27.41775463800006,85.06447431700006 27.415385983000096,85.06626569200004 27.414674953000063,85.067790555 27.414979080000002,85.06939179100007 27.41558770500009,85.07106927900013 27.416060943000076,85.07285991200006 27.412676560000005,85.07247815900008 27.410950895000042,85.07141047700011 27.409969910000054,85.07068559300009 27.40783823100007,85.06942763300002 27.40777096600001,85.06870338200004 27.407805037000077,85.06809358300004 27.408177467000073,85.06778891600005 27.409226587000013,85.06775106400002 27.41020793200003,85.06622600300005 27.408956328000034,85.06512036300005 27.408042971000047,85.06298612400003 27.40926173400008,85.0630245120001 27.410344557000055,85.06325346400004 27.411325806000065,85.06265491200007 27.41173151200006,85.06181623100005 27.41196861600005,85.06055813100005 27.41179974500002,85.05926182300009 27.410987923000086,85.05834677500005 27.41020983700001,85.057812846 27.408754855000062,85.05743148700007 27.407739737000004,85.05605921100005 27.407909263000086,85.05506814600002 27.40807868300007,85.0545345310001 27.408383354000055,85.05373410100005 27.408755752000047,85.05316243400009 27.409466487000056,85.05194267300006 27.409500547000032,85.0515997200001 27.410245057000083,85.05220966400003 27.410684853000056,85.05392499500003 27.41078605500008,85.05537368300007 27.411834762000076,85.05659373900004 27.413086527000086,85.05640337700001 27.414372408000077,85.057127988 27.415962635000025,85.05704186668629 27.416322866740906,85.05723732400008 27.416409576000056,85.05776512700005 27.416643717000067,85.0582195790001 27.416656646999982,85.05868873100009 27.41683874200004,85.05909925200004 27.41704687300003,85.05923126300004 27.41734614800001,85.0594659050001 27.417697454000034,85.05977383400008 27.417996693000102,85.06014034700003 27.418074698000073,85.06047758600005 27.418321877000007,85.06082951000012 27.41866014500002,85.06119604100007 27.418790200000032,85.06166514100008 27.41872503600006))', 4326) as geom
),
nearby AS (
    SELECT
        COALESCE(f.name, f.name_en, f.highway) as feature_name,
        ST_Distance(ST_Transform(i.geom, 32645), ST_Transform(f.geom, 32645)) as distance_m,
        degrees(ST_Azimuth(ST_Centroid(i.geom), ST_ClosestPoint(f.geom, ST_Centroid(i.geom)))) as azimuth_deg
    FROM infrastructure.road f, input_geom i
    WHERE ST_DWithin(ST_Transform(i.geom, 32645), ST_Transform(f.geom, 32645), 100)
)
SELECT
    feature_name,
    ROUND(distance_m::numeric, 1) as distance_m,
    ROUND(azimuth_deg::numeric, 1) as azimuth,
    CASE
        WHEN azimuth_deg >= 315 OR azimuth_deg < 45 THEN 'North'
        WHEN azimuth_deg >= 45 AND azimuth_deg < 135 THEN 'East'
        WHEN azimuth_deg >= 135 AND azimuth_deg < 225 THEN 'South'
        WHEN azimuth_deg >= 225 AND azimuth_deg < 315 THEN 'West'
    END as direction
FROM nearby
WHERE feature_name IS NOT NULL
AND feature_name != ''
ORDER BY distance_m
LIMIT 20;
