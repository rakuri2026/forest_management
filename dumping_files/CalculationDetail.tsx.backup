import { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { forestApi } from '../services/api';
import type { Calculation } from '../types';
import { MapContainer, TileLayer, GeoJSON, useMap } from 'react-leaflet';
import * as L from 'leaflet';
import 'leaflet/dist/leaflet.css';

// Import leaflet scale control (built-in)
import 'leaflet/dist/leaflet.css';

// Component to handle auto-zoom to layer and add scale control
function ZoomToLayer({
  geometry,
  setMapInstance,
  orientation
}: {
  geometry: any;
  setMapInstance: (map: L.Map) => void;
  orientation: 'portrait' | 'landscape';
}) {
  const map = useMap();

  useEffect(() => {
    // Store map instance for external use
    setMapInstance(map);

    // Remove any existing scale controls first
    map.eachLayer((layer: any) => {
      if (layer instanceof L.Control.Scale) {
        map.removeControl(layer);
      }
    });

    // Add single scale control (bottom-left)
    const scaleControl = L.control.scale({
      position: 'bottomleft',
      metric: true,
      imperial: false,
      maxWidth: 150
    });
    scaleControl.addTo(map);

    // Auto-zoom to layer on initial load - same behavior for both orientations
    if (geometry) {
      const geoJsonLayer = L.geoJSON(geometry);
      const bounds = geoJsonLayer.getBounds();
      if (bounds.isValid()) {
        // Use same padding for both portrait and landscape for consistent zoom behavior
        const padding = [50, 50] as [number, number];

        map.fitBounds(bounds, { padding });
      }
    }

    // Cleanup function
    return () => {
      if (map && scaleControl) {
        map.removeControl(scaleControl);
      }
    };
  }, [geometry, map, setMapInstance, orientation]);

  return null;
}

// North Arrow Component - Points upward (North)
function NorthArrow() {
  return (
    <div className="absolute top-4 right-4 z-[1000] bg-white rounded-lg shadow-lg p-2 border border-gray-300">
      <div className="flex flex-col items-center">
        <div className="text-sm font-bold text-gray-800 mb-1">N</div>
        <svg width="30" height="50" viewBox="0 0 30 60">
          {/* Arrow shaft */}
          <line x1="15" y1="10" x2="15" y2="50" stroke="#333" strokeWidth="2"/>
          {/* North half (dark/filled) pointing UP */}
          <polygon points="15,5 10,20 15,18 20,20" fill="#1a1a1a" stroke="#000" strokeWidth="1"/>
          {/* South half (white/outline) pointing DOWN */}
          <polygon points="15,18 10,20 15,50 20,20" fill="#ffffff" stroke="#000" strokeWidth="1"/>
        </svg>
      </div>
    </div>
  );
}

export default function CalculationDetail() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const [calculation, setCalculation] = useState<Calculation | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [mapInstance, setMapInstance] = useState<L.Map | null>(null);
  const [mapOrientation, setMapOrientation] = useState<'portrait' | 'landscape'>('portrait');

  useEffect(() => {
    if (id) {
      loadCalculation();
    }
  }, [id]);

  // Calculate optimal map orientation based on geometry extent
  useEffect(() => {
    if (calculation?.geometry) {
      const geoJsonLayer = L.geoJSON(calculation.geometry);
      const bounds = geoJsonLayer.getBounds();

      if (bounds.isValid()) {
        const width = bounds.getEast() - bounds.getWest();
        const height = bounds.getNorth() - bounds.getSouth();

        // If width > height, use landscape; otherwise portrait
        const orientation = width > height ? 'landscape' : 'portrait';
        setMapOrientation(orientation);
      }
    }
  }, [calculation]);

  const loadCalculation = async () => {
    try {
      setLoading(true);
      const data = await forestApi.getCalculation(id!);

      // DEBUG: Log what we received
      console.log('=== CALCULATION DATA RECEIVED ===');
      console.log('Forest Name:', data.forest_name);
      console.log('Top-level slope:', data.result_data?.slope_dominant_class);
      console.log('Top-level aspect:', data.result_data?.aspect_dominant);
      console.log('Blocks count:', data.result_data?.blocks?.length);
      if (data.result_data?.blocks?.[0]) {
        console.log('Block 0 slope:', data.result_data.blocks[0].slope_dominant_class);
        console.log('Block 0 aspect:', data.result_data.blocks[0].aspect_dominant);
      }
      console.log('=================================');

      setCalculation(data);
    } catch (err: any) {
      setError(err.response?.data?.detail || 'Failed to load calculation');
    } finally {
      setLoading(false);
    }
  };

  const getStatusBadge = (status: string) => {
    const styles = {
      processing: 'bg-yellow-100 text-yellow-800',
      completed: 'bg-green-100 text-green-800',
      failed: 'bg-red-100 text-red-800',
    };
    return styles[status as keyof typeof styles] || 'bg-gray-100 text-gray-800';
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleString();
  };

  const handleZoomToLayer = () => {
    if (calculation?.geometry && mapInstance) {
      const geoJsonLayer = L.geoJSON(calculation.geometry);
      const bounds = geoJsonLayer.getBounds();
      if (bounds.isValid()) {
        // Use same padding for both portrait and landscape for consistent zoom behavior
        const padding = [50, 50] as [number, number];

        mapInstance.fitBounds(bounds, { padding });
      }
    }
  };

  if (loading) {
    return (
      <div className="max-w-7xl mx-auto py-8 px-4">
        <div className="bg-white rounded-lg shadow p-8 text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Loading calculation details...</p>
        </div>
      </div>
    );
  }

  if (error || !calculation) {
    return (
      <div className="max-w-7xl mx-auto py-8 px-4">
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md">
          {error || 'Calculation not found'}
        </div>
        <button
          onClick={() => navigate('/my-uploads')}
          className="mt-4 text-green-600 hover:text-green-700"
        >
          ← Back to My Uploads
        </button>
      </div>
    );
  }

  // Extract blocks from result_data
  const blocks = calculation.result_data?.blocks || [];
  const totalBlocks = calculation.result_data?.total_blocks || 1;
  const processingInfo = calculation.result_data?.processing_info || {};

  return (
    <div className="max-w-7xl mx-auto py-8 px-4">
      <div className="mb-6">
        <button
          onClick={() => navigate('/my-uploads')}
          className="text-green-600 hover:text-green-700 flex items-center"
        >
          <svg className="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
          </svg>
          Back to My Uploads
        </button>
      </div>

      <div className="bg-white rounded-lg shadow overflow-hidden">
        {/* Header Section */}
        <div className="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-green-50 to-green-100">
          <h1 className="text-3xl font-bold text-gray-900">{calculation.forest_name}</h1>
          <div className="mt-2 flex items-center text-sm text-gray-600">
            <svg className="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span>Uploaded: {formatDate(calculation.created_at)}</span>
            <span className="mx-2">•</span>
            <span className="font-medium">{calculation.uploaded_filename}</span>
          </div>
          {totalBlocks > 1 && (
            <div className="mt-2 text-sm text-green-700 font-medium">
              {totalBlocks} Blocks {processingInfo.partitioned && '(Partitioned using division lines)'}
            </div>
          )}
        </div>


        {/* Whole Forest Analysis Section */}
        <div className="p-6 border-b border-gray-200">
          <h2 className="text-xl font-semibold text-gray-900 mb-4">
            {calculation.forest_name} Analysis
          </h2>
          <div className="border border-gray-300 rounded-lg bg-white shadow-sm">
            {/* Forest Header */}
            <div className="bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 border-b border-gray-200">
              <div className="flex justify-between items-center">
                <div>
                  <h3 className="text-lg font-bold text-gray-900">
                    Whole Forest Summary
                  </h3>
                  <p className="text-sm text-gray-600 mt-1">
                    Area: {calculation.result_data?.area_hectares?.toFixed(2)} hectares
                  </p>
                </div>
              </div>
            </div>

            {/* Forest Analysis Data Table */}
            <div className="p-6">
              <table className="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Parameter
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Value
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Details
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {/* Area */}
                  <tr className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                      Total Area
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                      {calculation.result_data?.area_hectares?.toFixed(2)} ha
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-600">
                      {(calculation.result_data?.area_sqm || 0).toLocaleString()} m²
                    </td>
                  </tr>

                  {/* Elevation */}
                  {calculation.result_data?.elevation_mean_m !== undefined && calculation.result_data?.elevation_mean_m > -32000 && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Elevation
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                        {calculation.result_data?.elevation_mean_m.toFixed(1)} m (mean)
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        Min: {calculation.result_data?.elevation_min_m?.toFixed(0)} m, Max: {calculation.result_data?.elevation_max_m?.toFixed(0)} m
                      </td>
                    </tr>
                  )}

                  {/* Slope */}
                  {calculation.result_data?.slope_dominant_class && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Slope
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                        <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                          calculation.result_data?.slope_dominant_class === 'flat' ? 'bg-blue-100 text-blue-800' :
                          calculation.result_data?.slope_dominant_class === 'gentle' ? 'bg-green-100 text-green-800' :
                          calculation.result_data?.slope_dominant_class === 'moderate' ? 'bg-yellow-100 text-yellow-800' :
                          calculation.result_data?.slope_dominant_class === 'steep' ? 'bg-orange-100 text-orange-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {calculation.result_data?.slope_dominant_class}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {calculation.result_data?.slope_percentages &&
                          Object.entries(calculation.result_data?.slope_percentages)
                            .map(([cls, pct]: [string, any]) => `${cls}: ${pct.toFixed(1)}%`)
                            .join(', ')
                        }
                      </td>
                    </tr>
                  )}

                  {/* Aspect */}
                  {calculation.result_data?.aspect_dominant && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Aspect (Orientation)
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize font-semibold">
                        {calculation.result_data?.aspect_dominant}
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {calculation.result_data?.aspect_percentages &&
                          Object.entries(calculation.result_data?.aspect_percentages)
                            .map(([dir, pct]: [string, any]) => `${dir}: ${pct.toFixed(1)}%`)
                            .join(', ')
                        }
                      </td>
                    </tr>
                  )}

                  {/* Canopy Height */}
                  {calculation.result_data?.canopy_dominant_class && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Canopy Structure
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                        {calculation.result_data?.canopy_dominant_class.replace('_', ' ')}
                        {calculation.result_data?.canopy_mean_m !== undefined && (
                          <span className="text-xs text-gray-500 ml-2">
                            ({calculation.result_data?.canopy_mean_m.toFixed(1)}m avg)
                          </span>
                        )}
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {calculation.result_data?.canopy_percentages &&
                          Object.entries(calculation.result_data?.canopy_percentages)
                            .map(([cls, pct]: [string, any]) => `${cls.replace('_', ' ')}: ${pct.toFixed(1)}%`)
                            .join(', ')
                        }
                      </td>
                    </tr>
                  )}

                  {/* Above Ground Biomass */}
                  {calculation.result_data?.agb_total_mg !== undefined && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Above Ground Biomass (AGB)
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                        {calculation.result_data?.agb_total_mg.toLocaleString()} Mg
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {calculation.result_data?.agb_mean_mg_ha?.toFixed(2)} Mg/ha (mean per hectare)
                      </td>
                    </tr>
                  )}

                  {/* Carbon Stock */}
                  {calculation.result_data?.carbon_stock_mg !== undefined && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Carbon Stock
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                        {calculation.result_data?.carbon_stock_mg.toLocaleString()} Mg
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        50% of total biomass
                      </td>
                    </tr>
                  )}

                  {/* Forest Health */}
                  {calculation.result_data?.forest_health_dominant && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Forest Health
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                        <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                          calculation.result_data?.forest_health_dominant === 'excellent' ? 'bg-green-100 text-green-800' :
                          calculation.result_data?.forest_health_dominant === 'good' ? 'bg-green-100 text-green-700' :
                          calculation.result_data?.forest_health_dominant === 'moderate' ? 'bg-yellow-100 text-yellow-800' :
                          calculation.result_data?.forest_health_dominant === 'poor' ? 'bg-orange-100 text-orange-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {calculation.result_data?.forest_health_dominant}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {calculation.result_data?.forest_health_percentages &&
                          Object.entries(calculation.result_data?.forest_health_percentages)
                            .map(([cls, pct]: [string, any]) => `${cls}: ${pct.toFixed(1)}%`)
                            .join(', ')
                        }
                      </td>
                    </tr>
                  )}

                  {/* Forest Type */}
                  {calculation.result_data?.forest_type_dominant && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Forest Type
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                        <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                          {calculation.result_data?.forest_type_dominant}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {calculation.result_data?.forest_type_percentages &&
                          Object.entries(calculation.result_data?.forest_type_percentages)
                            .map(([type, pct]: [string, any]) => `${type}: ${pct.toFixed(1)}%`)
                            .join(', ')
                        }
                      </td>
                    </tr>
                  )}

                  {/* Land Cover */}
                  {calculation.result_data?.landcover_dominant && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Land Cover
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                        <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                          {calculation.result_data?.landcover_dominant}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {calculation.result_data?.landcover_percentages &&
                          Object.entries(calculation.result_data?.landcover_percentages)
                            .map(([cover, pct]: [string, any]) => `${cover}: ${pct.toFixed(1)}%`)
                            .join(', ')
                        }
                      </td>
                    </tr>
                  )}

                  {/* Forest Loss */}
                  {calculation.result_data?.forest_loss_hectares !== undefined && calculation.result_data?.forest_loss_hectares >= 0 && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Forest Loss (2001-2023)
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                        <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                          {calculation.result_data?.forest_loss_hectares.toFixed(2)} ha
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {calculation.result_data?.forest_loss_by_year &&
                          Object.entries(calculation.result_data?.forest_loss_by_year)
                            .sort(([yearA], [yearB]) => parseInt(yearA) - parseInt(yearB))
                            .map(([year, ha]: [string, any]) => `${year}: ${ha.toFixed(2)} ha`)
                            .join(', ')
                        }
                      </td>
                    </tr>
                  )}

                  {/* Forest Gain */}
                  {calculation.result_data?.forest_gain_hectares !== undefined && calculation.result_data?.forest_gain_hectares >= 0 && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Forest Gain (2000-2012)
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                        <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                          {calculation.result_data?.forest_gain_hectares.toFixed(2)} ha
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        Net forest gain over 12-year period
                      </td>
                    </tr>
                  )}

                  {/* Fire Loss */}
                  {calculation.result_data?.fire_loss_hectares !== undefined && calculation.result_data?.fire_loss_hectares >= 0 && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Fire Loss (2001-2023)
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                        <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">
                          {calculation.result_data?.fire_loss_hectares.toFixed(2)} ha
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {calculation.result_data?.fire_loss_by_year &&
                          Object.entries(calculation.result_data?.fire_loss_by_year)
                            .sort(([yearA], [yearB]) => parseInt(yearA) - parseInt(yearB))
                            .map(([year, ha]: [string, any]) => `${year}: ${ha.toFixed(2)} ha`)
                            .join(', ')
                        }
                      </td>
                    </tr>
                  )}

                  {/* Temperature */}
                  {calculation.result_data?.temperature_mean_c !== undefined && calculation.result_data?.temperature_mean_c > -100 && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Temperature
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                        {calculation.result_data?.temperature_mean_c.toFixed(1)} °C (mean)
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        Min (coldest month): {calculation.result_data?.temperature_min_coldest_c?.toFixed(1)} °C
                      </td>
                    </tr>
                  )}

                  {/* Precipitation */}
                  {calculation.result_data?.precipitation_mean_mm !== undefined && calculation.result_data?.precipitation_mean_mm >= 0 && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Precipitation
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                        {calculation.result_data?.precipitation_mean_mm.toFixed(0)} mm/year
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        Annual total precipitation
                      </td>
                    </tr>
                  )}

                  {/* Soil Texture */}
                  {calculation.result_data?.soil_texture && (
                    <tr className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        Soil Texture
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                        <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                          {calculation.result_data?.soil_texture}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-600">
                        {calculation.result_data?.soil_properties &&
                          Object.entries(calculation.result_data?.soil_properties)
                            .map(([prop, val]: [string, any]) => `${prop}: ${val}`)
                            .join(', ')
                        }
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        {/* Forest Blocks Detailed Analysis Section */}
        {blocks.length > 0 && (
          <div className="p-6">
            <h2 className="text-xl font-semibold text-gray-900 mb-4">Forest Blocks Detailed Analysis</h2>
            <div className="space-y-8">
              {blocks.map((block: any, index: number) => {
                const areaHa = block.area_hectares ? parseFloat(block.area_hectares).toFixed(2) : '0.00';

                return (
                  <div key={index} className="border border-gray-300 rounded-lg bg-white shadow-sm">
                    {/* Block Header */}
                    <div className="bg-gradient-to-r from-green-50 to-green-100 px-6 py-4 border-b border-gray-200">
                      <div className="flex justify-between items-center">
                        <div>
                          <h3 className="text-lg font-bold text-gray-900">
                            Block #{index + 1}: {block.block_name}
                          </h3>
                          <p className="text-sm text-gray-600 mt-1">Area: {areaHa} hectares</p>
                        </div>
                      </div>
                    </div>

                    {/* Block Analysis Data Table */}
                    <div className="p-6">
                      <table className="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Parameter
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Value
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Details
                            </th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {/* Area */}
                          <tr className="hover:bg-gray-50">
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                              Area
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                              {areaHa} ha
                            </td>
                            <td className="px-6 py-4 text-sm text-gray-600">
                              {(block.area_sqm || 0).toLocaleString()} m²
                            </td>
                          </tr>

                          {/* Elevation */}
                          {block.elevation_mean_m !== undefined && block.elevation_mean_m > -32000 && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Elevation
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                                {block.elevation_mean_m.toFixed(1)} m (mean)
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                Min: {block.elevation_min_m?.toFixed(0)} m, Max: {block.elevation_max_m?.toFixed(0)} m
                              </td>
                            </tr>
                          )}

                          {/* Slope */}
                          {block.slope_dominant_class && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Slope
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                                <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                  block.slope_dominant_class === 'flat' ? 'bg-blue-100 text-blue-800' :
                                  block.slope_dominant_class === 'gentle' ? 'bg-green-100 text-green-800' :
                                  block.slope_dominant_class === 'moderate' ? 'bg-yellow-100 text-yellow-800' :
                                  block.slope_dominant_class === 'steep' ? 'bg-orange-100 text-orange-800' :
                                  'bg-red-100 text-red-800'
                                }`}>
                                  {block.slope_dominant_class}
                                </span>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                {block.slope_percentages &&
                                  Object.entries(block.slope_percentages)
                                    .map(([cls, pct]: [string, any]) => `${cls}: ${pct.toFixed(1)}%`)
                                    .join(', ')
                                }
                              </td>
                            </tr>
                          )}

                          {/* Aspect */}
                          {block.aspect_dominant && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Aspect (Orientation)
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize font-semibold">
                                {block.aspect_dominant}
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                {block.aspect_percentages &&
                                  Object.entries(block.aspect_percentages)
                                    .map(([dir, pct]: [string, any]) => `${dir}: ${pct.toFixed(1)}%`)
                                    .join(', ')
                                }
                              </td>
                            </tr>
                          )}

                          {/* Canopy Height */}
                          {block.canopy_dominant_class && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Canopy Structure
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                                {block.canopy_dominant_class.replace('_', ' ')}
                                {block.canopy_mean_m !== undefined && (
                                  <span className="text-xs text-gray-500 ml-2">
                                    ({block.canopy_mean_m.toFixed(1)}m avg)
                                  </span>
                                )}
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                {block.canopy_percentages &&
                                  Object.entries(block.canopy_percentages)
                                    .map(([cls, pct]: [string, any]) => `${cls.replace('_', ' ')}: ${pct.toFixed(1)}%`)
                                    .join(', ')
                                }
                              </td>
                            </tr>
                          )}

                          {/* Above Ground Biomass */}
                          {block.agb_total_mg !== undefined && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Above Ground Biomass (AGB)
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                                {block.agb_total_mg.toLocaleString()} Mg
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                {block.agb_mean_mg_ha?.toFixed(2)} Mg/ha (mean per hectare)
                              </td>
                            </tr>
                          )}

                          {/* Carbon Stock */}
                          {block.carbon_stock_mg !== undefined && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Carbon Stock
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                                {block.carbon_stock_mg.toLocaleString()} Mg
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                50% of total biomass
                              </td>
                            </tr>
                          )}

                          {/* Forest Health */}
                          {block.forest_health_dominant && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Forest Health
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                                <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                  block.forest_health_dominant === 'excellent' ? 'bg-green-100 text-green-800' :
                                  block.forest_health_dominant === 'good' ? 'bg-green-100 text-green-700' :
                                  block.forest_health_dominant === 'moderate' ? 'bg-yellow-100 text-yellow-800' :
                                  block.forest_health_dominant === 'poor' ? 'bg-orange-100 text-orange-800' :
                                  'bg-red-100 text-red-800'
                                }`}>
                                  {block.forest_health_dominant}
                                </span>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                {block.forest_health_percentages &&
                                  Object.entries(block.forest_health_percentages)
                                    .map(([health, pct]: [string, any]) => `${health}: ${pct.toFixed(1)}%`)
                                    .join(', ')
                                }
                              </td>
                            </tr>
                          )}

                          {/* Forest Type */}
                          {block.forest_type_dominant && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Forest Type
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                                <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                  {block.forest_type_dominant}
                                </span>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                {block.forest_type_percentages &&
                                  Object.entries(block.forest_type_percentages)
                                    .map(([type, pct]: [string, any]) => `${type}: ${pct.toFixed(1)}%`)
                                    .join(', ')
                                }
                              </td>
                            </tr>
                          )}

                          {/* Land Cover */}
                          {block.landcover_dominant && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Land Cover
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                                <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                  {block.landcover_dominant}
                                </span>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                {block.landcover_percentages &&
                                  Object.entries(block.landcover_percentages)
                                    .map(([cover, pct]: [string, any]) => `${cover}: ${pct.toFixed(1)}%`)
                                    .join(', ')
                                }
                              </td>
                            </tr>
                          )}

                          {/* Forest Loss */}
                          {block.forest_loss_hectares !== undefined && block.forest_loss_hectares >= 0 && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Forest Loss (2001-2023)
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                                <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                  {block.forest_loss_hectares.toFixed(2)} ha
                                </span>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                {block.forest_loss_by_year &&
                                  Object.entries(block.forest_loss_by_year)
                                    .sort(([yearA], [yearB]) => parseInt(yearA) - parseInt(yearB))
                                    .map(([year, ha]: [string, any]) => `${year}: ${ha.toFixed(2)} ha`)
                                    .join(', ')
                                }
                              </td>
                            </tr>
                          )}

                          {/* Forest Gain */}
                          {block.forest_gain_hectares !== undefined && block.forest_gain_hectares >= 0 && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Forest Gain (2000-2012)
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                                <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                  {block.forest_gain_hectares.toFixed(2)} ha
                                </span>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                Net forest gain over 12-year period
                              </td>
                            </tr>
                          )}

                          {/* Fire Loss */}
                          {block.fire_loss_hectares !== undefined && block.fire_loss_hectares >= 0 && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Fire Loss (2001-2023)
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                                <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">
                                  {block.fire_loss_hectares.toFixed(2)} ha
                                </span>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                {block.fire_loss_by_year &&
                                  Object.entries(block.fire_loss_by_year)
                                    .sort(([yearA], [yearB]) => parseInt(yearA) - parseInt(yearB))
                                    .map(([year, ha]: [string, any]) => `${year}: ${ha.toFixed(2)} ha`)
                                    .join(', ')
                                }
                              </td>
                            </tr>
                          )}

                          {/* Temperature */}
                          {block.temperature_mean_c !== undefined && block.temperature_mean_c > -100 && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Temperature
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                                {block.temperature_mean_c.toFixed(1)} °C (mean)
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                Min (coldest month): {block.temperature_min_coldest_c?.toFixed(1)} °C
                              </td>
                            </tr>
                          )}

                          {/* Precipitation */}
                          {block.precipitation_mean_mm !== undefined && block.precipitation_mean_mm >= 0 && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Precipitation
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                                {block.precipitation_mean_mm.toFixed(0)} mm/year
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                Annual total precipitation
                              </td>
                            </tr>
                          )}

                          {/* Soil Texture */}
                          {block.soil_texture && (
                            <tr className="hover:bg-gray-50">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Soil Texture
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                                <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                  {block.soil_texture}
                                </span>
                              </td>
                              <td className="px-6 py-4 text-sm text-gray-600">
                                {block.soil_properties &&
                                  Object.entries(block.soil_properties)
                                    .map(([prop, val]: [string, any]) => `${prop}: ${val}`)
                                    .join(', ')
                                }
                              </td>
                            </tr>
                          )}
                        </tbody>
                      </table>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Summary Footer */}
            <div className="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
              <div className="flex justify-between items-center">
                <span className="text-sm font-semibold text-gray-900">
                  Total: {blocks.length} {blocks.length === 1 ? 'block' : 'blocks'}
                </span>
                <span className="text-sm font-semibold text-gray-900 font-mono">
                  Combined Area: {blocks.reduce((sum: number, b: any) => sum + parseFloat(b.area_hectares || 0), 0).toFixed(2)} ha
                </span>
              </div>
            </div>
          </div>
        )}

        {/* Additional Information */}
        <div className="px-6 pb-6">
          <dl className="grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3">
            <div>
              <dt className="text-sm font-medium text-gray-500">Status</dt>
              <dd className="mt-1">
                <span
                  className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadge(
                    calculation.status
                  )}`}
                >
                  {calculation.status}
                </span>
              </dd>
            </div>

            {calculation.processing_time_seconds && (
              <div>
                <dt className="text-sm font-medium text-gray-500">Processing Time</dt>
                <dd className="mt-1 text-sm text-gray-900">
                  {calculation.processing_time_seconds} seconds
                </dd>
              </div>
            )}

            {calculation.completed_at && (
              <div>
                <dt className="text-sm font-medium text-gray-500">Completed At</dt>
                <dd className="mt-1 text-sm text-gray-900">
                  {formatDate(calculation.completed_at)}
                </dd>
              </div>
            )}

            {calculation.error_message && (
              <div className="sm:col-span-3">
                <dt className="text-sm font-medium text-gray-500">Error Message</dt>
                <dd className="mt-1 text-sm text-red-600">{calculation.error_message}</dd>
              </div>
            )}
          </dl>
        </div>

        {/* Map Section */}
        {calculation.geometry && (
          <div className="px-6 pb-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-semibold text-gray-900">
                Boundary Map (A5 - {mapOrientation === 'portrait' ? 'Portrait' : 'Landscape'})
              </h2>
              <button
                onClick={handleZoomToLayer}
                className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors shadow-sm"
              >
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                </svg>
                Zoom to Layer
              </button>
            </div>
            <div
              className="rounded-lg overflow-hidden border-2 border-gray-400 shadow-lg mx-auto relative"
              style={{
                width: mapOrientation === 'portrait' ? '560px' : '794px',
                height: mapOrientation === 'portrait' ? '794px' : '560px'
              }}
            >
              <MapContainer
                center={[27.7, 85.3]}
                zoom={7}
                style={{ height: '100%', width: '100%' }}
                zoomControl={true}
                attributionControl={true}
              >
                <TileLayer
                  attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                  url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                />
                <GeoJSON
                  data={calculation.geometry}
                  style={{
                    color: '#059669',
                    weight: 3,
                    fillColor: '#34d399',
                    fillOpacity: 0.3
                  }}
                />
                <ZoomToLayer
                  geometry={calculation.geometry}
                  setMapInstance={setMapInstance}
                  orientation={mapOrientation}
                />
              </MapContainer>
              <NorthArrow />
            </div>
            <div className="mt-3 text-center">
              <p className="text-sm text-gray-500">
                A5 Map Size: {mapOrientation === 'portrait' ? '560px × 794px (148mm × 210mm)' : '794px × 560px (210mm × 148mm)'} at 96 DPI
                {totalBlocks > 1 && (
                  <span className="block mt-1 italic">
                    Map shows all {totalBlocks} blocks combined
                  </span>
                )}
              </p>
            </div>
          </div>
        )}

        {/* Processing Info Section - Only show if partitioned */}
        {processingInfo.partitioned && (
          <div className="px-6 pb-6">
            <h2 className="text-xl font-semibold text-gray-900 mb-4">Processing Information</h2>
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div className="flex items-start">
                <svg className="w-5 h-5 text-blue-600 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                </svg>
                <div className="flex-1">
                  <p className="text-sm text-blue-800 font-medium">Compartment Boundary Partitioning Applied</p>
                  <p className="mt-1 text-sm text-blue-700">
                    The outer boundary was partitioned using {processingInfo.partition_info?.division_lines_used || 0} division lines,
                    creating {processingInfo.partition_info?.blocks_created || 0} separate forest blocks.
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
